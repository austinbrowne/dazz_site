---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import PickCard from '../../../components/PickCard.astro';
import EmptyState from '../../../components/EmptyState.astro';
import { getProducts } from '../../../lib/api';
import { CATEGORY_LABELS, CATEGORY_SLUGS } from '../../../lib/types';

export async function getStaticPaths() {
  const products = await getProducts();

  if (products.length === 0) {
    console.warn('getStaticPaths: API returned 0 products — no category pages will be generated');
    return [];
  }

  return CATEGORY_SLUGS.map((slug) => {
    const categoryProducts = products
      .filter((p) => p.category_slug === slug)
      .sort((a, b) => (b.rating ?? 0) - (a.rating ?? 0));

    return {
      params: { category: slug },
      props: { categorySlug: slug, products: categoryProducts },
    };
  });
}

interface Props {
  categorySlug: CategorySlug;
  products: import('../../../lib/types').Product[];
}

const { categorySlug, products } = Astro.props;
const categoryLabel = CATEGORY_LABELS[categorySlug];
const pageTitle = `${categoryLabel} Reviews`;
const pageDescription = `Browse our ${categoryLabel.toLowerCase()} reviews.`;
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <div class="max-w-6xl mx-auto px-4 py-8">
    <!-- Breadcrumb -->
    <nav aria-label="Breadcrumb" class="mb-6">
      <ol class="flex items-center gap-2 text-sm text-zinc-400">
        <li><a href="/reviews" class="hover:text-white transition-colors">Reviews</a></li>
        <li aria-hidden="true" class="text-zinc-600">/</li>
        <li aria-current="page" class="text-zinc-200">{categoryLabel}</li>
      </ol>
    </nav>

    <h1 class="text-3xl font-bold text-white mb-2">{categoryLabel} Reviews</h1>
    <p class="text-zinc-400 mb-8">{products.length} {products.length === 1 ? 'review' : 'reviews'}</p>

    {/* Compare Mice link card — only shown on the mice category page */}
    {categorySlug === 'mice' && products.length > 0 && (
      <a
        href="/compare"
        class="group flex items-center gap-3 bg-zinc-900 border border-zinc-800 rounded-xl p-4 mb-8 hover:border-indigo-500/50 hover:bg-zinc-900/80 transition-colors"
      >
        <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-indigo-600/20 flex items-center justify-center">
          <svg class="w-5 h-5 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h4V3H3v7zm7 11h4V6h-4v15zm7-7h4v-4h-4v4z" />
          </svg>
        </div>
        <div class="flex-1 min-w-0">
          <span class="text-sm font-semibold text-white group-hover:text-indigo-400 transition-colors">Compare Mice</span>
          <p class="text-xs text-zinc-400 mt-0.5">
            Side-by-side specs table — sort by weight, sensor, price, and more
          </p>
        </div>
        <svg class="w-5 h-5 text-zinc-600 group-hover:text-indigo-400 transition-colors flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </a>
    )}

    {products.length > 0 ? (
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        {products.map((product) => (
          <PickCard product={product} />
        ))}
      </div>
    ) : (
      <EmptyState
        title={`No ${categoryLabel.toLowerCase()} reviews yet`}
        description={`We haven't reviewed any ${categoryLabel.toLowerCase()} yet. Check out our other categories.`}
        ctaText="Browse all reviews"
        ctaHref="/reviews"
      />
    )}
  </div>
</BaseLayout>
