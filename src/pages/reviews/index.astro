---
import BaseLayout from '../../layouts/BaseLayout.astro';
import EmptyState from '../../components/EmptyState.astro';
import { getProducts } from '../../lib/api';
import { CATEGORY_LABELS, CATEGORY_SLUGS } from '../../lib/types';

const products = await getProducts();
const hasProducts = products.length > 0;

// Price ranges for the filter dropdown
const PRICE_RANGES = [
  { label: 'Any price', value: '' },
  { label: 'Under $25', value: '0-25' },
  { label: '$25 – $50', value: '25-50' },
  { label: '$50 – $100', value: '50-100' },
  { label: '$100 – $200', value: '100-200' },
  { label: 'Over $200', value: '200-' },
];
---

<BaseLayout title="Reviews" description="All gaming peripheral reviews — mice, keyboards, mousepads, IEMs, and more.">
  <div class="max-w-6xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-white mb-2">Reviews</h1>
    <p class="text-zinc-400 mb-8">All gaming peripheral reviews, filterable by category.</p>

    {hasProducts ? (
      <>
        <!-- Category Quick Links -->
        <nav class="flex flex-wrap gap-2 mb-8" aria-label="Category links">
          {CATEGORY_SLUGS.map((slug) => (
            <a
              href={`/reviews/${slug}`}
              class="px-4 py-2 bg-zinc-900 border border-zinc-800 rounded-lg text-sm text-zinc-300 hover:text-white hover:border-zinc-600 transition-colors"
            >
              {CATEGORY_LABELS[slug]}
            </a>
          ))}
        </nav>

        <!-- Filters -->
        <div class="bg-zinc-900 border border-zinc-800 rounded-xl p-4 mb-8" data-filter-container>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <fieldset>
              <legend class="text-xs font-semibold text-zinc-400 mb-2">Category</legend>
              <div class="flex flex-wrap gap-2">
                {CATEGORY_SLUGS.map((slug) => (
                  <label class="flex items-center gap-1.5 text-sm text-zinc-300 cursor-pointer">
                    <input
                      type="checkbox"
                      value={slug}
                      data-filter-category
                      checked
                      class="rounded border-zinc-600 bg-zinc-800 text-indigo-600 focus:ring-indigo-500 focus:ring-offset-zinc-900"
                    />
                    {CATEGORY_LABELS[slug]}
                  </label>
                ))}
                <label class="flex items-center gap-1.5 text-sm text-zinc-300 cursor-pointer">
                  <input
                    type="checkbox"
                    value="other"
                    data-filter-category
                    checked
                    class="rounded border-zinc-600 bg-zinc-800 text-indigo-600 focus:ring-indigo-500 focus:ring-offset-zinc-900"
                  />
                  Other
                </label>
              </div>
            </fieldset>

            <fieldset>
              <legend class="text-xs font-semibold text-zinc-400 mb-2">Price Range</legend>
              <select
                data-filter-price
                class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-sm text-zinc-300 focus:ring-indigo-500 focus:border-indigo-500"
              >
                {PRICE_RANGES.map(({ label, value }) => (
                  <option value={value}>{label}</option>
                ))}
              </select>
            </fieldset>

            <fieldset>
              <legend class="text-xs font-semibold text-zinc-400 mb-2">Minimum Rating</legend>
              <select
                data-filter-rating
                class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-sm text-zinc-300 focus:ring-indigo-500 focus:border-indigo-500"
              >
                <option value="0">Any rating</option>
                <option value="5">5+ / 10</option>
                <option value="6">6+ / 10</option>
                <option value="7">7+ / 10</option>
                <option value="8">8+ / 10</option>
                <option value="9">9+ / 10</option>
              </select>
            </fieldset>
          </div>
        </div>

        <!-- Results Count -->
        <div data-filter-status aria-live="polite" aria-atomic="true" class="text-sm text-zinc-400 mb-4">
          Showing {products.length} of {products.length} products
        </div>

        <!-- Product Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" data-product-grid>
          {products.map((product) => (
            <article
              class="bg-zinc-900 border border-zinc-800 rounded-xl overflow-hidden flex flex-col hover:border-zinc-700 transition-colors"
              data-product-card
              data-category={product.category_slug ?? 'other'}
              data-price={product.retail_price && product.retail_price > 0 ? product.retail_price : ''}
              data-rating={product.rating ?? ''}
            >
              <a href={`/reviews/${product.category_slug ?? 'other'}/${product.slug}`} class="block">
                <div class="aspect-[4/3] bg-zinc-800 flex items-center justify-center overflow-hidden">
                  {product.image_url?.startsWith('https://') ? (
                    <img
                      src={product.image_url}
                      alt={`Photo of ${product.product_name}`}
                      class="w-full h-full object-contain p-4"
                      loading="lazy"
                    />
                  ) : (
                    <svg class="w-16 h-16 text-zinc-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909M3.75 21h16.5A2.25 2.25 0 0022.5 18.75V5.25A2.25 2.25 0 0020.25 3H3.75A2.25 2.25 0 001.5 5.25v13.5A2.25 2.25 0 003.75 21z" />
                    </svg>
                  )}
                </div>
              </a>

              <div class="p-4 flex flex-col flex-1">
                {product.company_name && (
                  <p class="text-xs text-zinc-500 mb-1">{product.company_name}</p>
                )}

                <a href={`/reviews/${product.category_slug ?? 'other'}/${product.slug}`} class="hover:text-indigo-400 transition-colors">
                  <h3 class="text-sm font-semibold text-white mb-1 line-clamp-2">{product.product_name}</h3>
                </a>

                {product.rating != null && (
                  <div class="flex items-center gap-1 mb-2">
                    <span class="text-xs font-bold text-indigo-400">{product.rating}/10</span>
                  </div>
                )}

                {product.short_verdict && (
                  <p class="text-xs text-zinc-400 mb-3 line-clamp-2 flex-1">{product.short_verdict}</p>
                )}

                <div class="flex items-center justify-between mt-auto pt-2 border-t border-zinc-800">
                  {product.retail_price && product.retail_price > 0 ? (
                    <span class="text-sm font-semibold text-white">${product.retail_price.toFixed(2)}</span>
                  ) : (
                    <span></span>
                  )}

                  <a
                    href={`/reviews/${product.category_slug ?? 'other'}/${product.slug}`}
                    class="text-xs font-medium px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-md transition-colors"
                  >
                    Read Review
                  </a>
                </div>
              </div>
            </article>
          ))}
        </div>

        <!-- No Results -->
        <div data-no-results class="hidden text-center py-12">
          <p class="text-zinc-400">No products match your filters.</p>
          <button data-reset-filters class="mt-4 text-sm text-indigo-400 hover:text-indigo-300 transition-colors underline">
            Reset filters
          </button>
        </div>
      </>
    ) : (
      <EmptyState
        title="Reviews coming soon"
        description="Product reviews are being added to the site. Check back soon or subscribe to the newsletter."
        ctaText="Go Home"
        ctaHref="/"
      />
    )}
  </div>

  {hasProducts && (
    <script>
      function initFilters() {
        const container = document.querySelector('[data-filter-container]');
        if (!container) return;

        const cards = document.querySelectorAll<HTMLElement>('[data-product-card]');
        const statusEl = document.querySelector('[data-filter-status]');
        const noResultsEl = document.querySelector('[data-no-results]');
        const gridEl = document.querySelector('[data-product-grid]');
        const totalCount = cards.length;

        function getFilterState() {
          const categories = Array.from(
            container!.querySelectorAll<HTMLInputElement>('[data-filter-category]:checked')
          ).map((cb) => cb.value);

          const priceRange = (container!.querySelector<HTMLSelectElement>('[data-filter-price]')?.value) || '';
          const minRating = parseFloat(
            (container!.querySelector<HTMLSelectElement>('[data-filter-rating]')?.value) || '0'
          );

          return { categories, priceRange, minRating };
        }

        function applyFilters() {
          const { categories, priceRange, minRating } = getFilterState();
          let visible = 0;

          let priceMin = 0;
          let priceMax = Infinity;
          if (priceRange) {
            const parts = priceRange.split('-');
            priceMin = Number(parts[0]) || 0;
            priceMax = parts[1] ? Number(parts[1]) : Infinity;
            if (!Number.isFinite(priceMin)) priceMin = 0;
          }

          cards.forEach((card) => {
            const cat = card.dataset.category || '';
            const priceRaw = card.dataset.price ? parseFloat(card.dataset.price) : NaN;
            const price = Number.isFinite(priceRaw) ? priceRaw : null;
            const ratingRaw = card.dataset.rating ? parseFloat(card.dataset.rating) : NaN;
            const rating = Number.isFinite(ratingRaw) ? ratingRaw : null;

            let show = true;

            // Category filter
            if (!categories.includes(cat)) show = false;

            // Price filter
            if (show && priceRange) {
              if (price === null) {
                show = false;
              } else {
                show = price >= priceMin && price <= priceMax;
              }
            }

            // Rating filter
            if (show && minRating > 0) {
              if (rating === null || rating < minRating) show = false;
            }

            card.classList.toggle('hidden', !show);
            if (show) visible++;
          });

          if (statusEl) {
            statusEl.textContent = `Showing ${visible} of ${totalCount} products`;
          }

          if (noResultsEl) {
            noResultsEl.classList.toggle('hidden', visible > 0);
          }
          if (gridEl) {
            (gridEl as HTMLElement).classList.toggle('hidden', visible === 0);
          }

          // Persist to URL
          const params = new URLSearchParams();
          if (categories.length < totalCategoryCount()) {
            params.set('cat', categories.join(','));
          }
          if (priceRange) params.set('price', priceRange);
          if (minRating > 0) params.set('rating', String(minRating));

          const qs = params.toString();
          history.replaceState(null, '', qs ? `?${qs}` : location.pathname);
        }

        function totalCategoryCount() {
          return container!.querySelectorAll('[data-filter-category]').length;
        }

        function restoreFromURL() {
          const params = new URLSearchParams(location.search);

          const cat = params.get('cat');
          if (cat) {
            const selected = new Set(cat.split(','));
            container!.querySelectorAll<HTMLInputElement>('[data-filter-category]').forEach((cb) => {
              cb.checked = selected.has(cb.value);
            });
          }

          const price = params.get('price');
          if (price) {
            const select = container!.querySelector<HTMLSelectElement>('[data-filter-price]');
            if (select) select.value = price;
          }

          const rating = params.get('rating');
          if (rating) {
            const select = container!.querySelector<HTMLSelectElement>('[data-filter-rating]');
            if (select) select.value = rating;
          }
        }

        function resetFilters() {
          container!.querySelectorAll<HTMLInputElement>('[data-filter-category]').forEach((cb) => {
            cb.checked = true;
          });
          const priceSelect = container!.querySelector<HTMLSelectElement>('[data-filter-price]');
          if (priceSelect) priceSelect.value = '';
          const ratingSelect = container!.querySelector<HTMLSelectElement>('[data-filter-rating]');
          if (ratingSelect) ratingSelect.value = '0';
          applyFilters();
        }

        // Event listeners
        container!.querySelectorAll('[data-filter-category]').forEach((cb) => {
          cb.addEventListener('change', applyFilters);
        });
        container!.querySelector('[data-filter-price]')?.addEventListener('change', applyFilters);
        container!.querySelector('[data-filter-rating]')?.addEventListener('change', applyFilters);
        document.querySelector('[data-reset-filters]')?.addEventListener('click', resetFilters);

        // Restore state from URL and apply
        restoreFromURL();
        applyFilters();
      }

      // Run on DOM ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initFilters);
      } else {
        initFilters();
      }
    </script>
  )}
</BaseLayout>
